# 灯油配送管理システム - 本番環境セットアップマニュアル

## 📋 目次
1. [必要なもの](#必要なもの)
2. [マスタデータの準備](#マスタデータの準備)
3. [JSON変換手順](#json変換手順)
4. [アプリへのデータ取り込み](#アプリへのデータ取り込み)
5. [トラブルシューティング](#トラブルシューティング)

---

## 1. 必要なもの

### ✅ ファイル
- `customers.csv` - 顧客マスタ
- `tanks.csv` - タンクマスタ
- `convert_customers_v2.py` - 変換スクリプト

### ✅ 環境
- Python 3.x がインストールされていること
- Mac/Windows/Linux いずれでもOK

---

## 2. マスタデータの準備

### 📝 customers.csv の形式

```csv
customerCode,officialName,officialKana,unitPrice
1001,田中農場,タナカノウジョウ,105
1002,山田牧場,ヤマダボクジョウ,103
1003,鈴木ファーム,スズキファーム,107
```

**フィールド説明**:
- `customerCode`: 顧客コード（重複不可、4桁推奨）
- `officialName`: 顧客名（正式名称）
- `officialKana`: 顧客名カナ（任意、空欄可）
- `unitPrice`: 単価（円/L）

### 📝 tanks.csv の形式

```csv
tankId,customerCode,tankName,tankCapacity
1,1001,牛舎A,500
2,1001,牛舎B,500
3,1001,事務所,300
4,1002,ハウス1,400
```

**フィールド説明**:
- `tankId`: タンクID（重複不可、連番推奨）
- `customerCode`: 顧客コード（customers.csvと一致）
- `tankName`: タンク名（「牛舎1」「搾乳舎」など）
- `tankCapacity`: タンク容量（Liter）

### ⚠️ 重要な注意点

1. **文字コード**: Shift-JIS (cp932) で保存すること
   - Macの場合: テキストエディットで「エンコーディング: 日本語(Shift JIS)」
   - Windowsの場合: ExcelでCSV保存すると自動的にShift-JIS

2. **顧客コードの一致**: tanks.csvの`customerCode`は必ず`customers.csv`に存在すること

3. **ID の重複**: `customerCode`と`tankId`は重複しないこと

4. **データ検証**:
   - 顧客コードは4桁程度（例: 1001, 1002...）
   - タンクIDは連番（例: 1, 2, 3...）
   - 単価は正の整数
   - タンク容量は正の整数

---

## 3. JSON変換手順

### 📁 ディレクトリ構成

作業フォルダを作成し、以下の構成にします：

```
kerosene-delivery/
├── convert_customers_v2.py  ← 変換スクリプト
├── input/                    ← ここにCSVを配置
│   ├── customers.csv
│   └── tanks.csv
└── output/                   ← 変換後のJSONが出力される
    ├── customers.json
    └── tanks.json
```

### 🚀 変換実行

#### Step 1: inputフォルダ作成
```bash
mkdir input
```

#### Step 2: CSVファイルをinputフォルダに配置
- `customers.csv` を `input/` にコピー
- `tanks.csv` を `input/` にコピー

#### Step 3: 変換スクリプト実行
```bash
python3 convert_customers_v2.py
```

#### Step 4: 結果確認

成功すると以下のような出力が表示されます：

```
============================================================
灯油配送管理システム - マスタデータ変換 v2.0
============================================================

📁 出力先: /path/to/output

📖 顧客マスタ読み込み: input/customers.csv
   ✅ 4件の顧客データを読み込みました

📖 タンクマスタ読み込み: input/tanks.csv
   ✅ 11件のタンクデータを読み込みました

🔄 顧客データ変換中...
   ✅ 4件の顧客データを変換しました

🔄 タンクデータ変換中...
   ✅ 11件のタンクデータを変換しました

💾 JSON保存: output/customers.json
   ✅ customers.json を保存しました

💾 JSON保存: output/tanks.json
   ✅ tanks.json を保存しました

============================================================
✅ 変換完了！
============================================================

📋 変換結果:
   - 顧客: 4件
   - タンク: 11件

💡 次のステップ:
   1. output フォルダの customers.json と tanks.json を確認
   2. ブラウザで灯油配送管理システムを開く
   3. データ管理セクションから JSON を取り込む

📊 顧客ごとのタンク数:
   1234 (かっとびファーム): 3基
   2234 (かっとび農場): 3基
   3234 (かっとび農園): 3基
   4234 (かっとび幼稚園): 2基
```

#### Step 5: JSONファイルを確認

`output/` フォルダに以下が生成されます：
- `customers.json` - UTF-8エンコード
- `tanks.json` - UTF-8エンコード

---

## 4. アプリへのデータ取り込み

### 📱 取り込み手順

1. **ブラウザでindex.htmlを開く**
   - Mac: Safari または Chrome
   - iPad: Safari

2. **初回起動時の画面**
   ```
   🚀 初回セットアップが必要です
   
   顧客・タンクマスタがまだ登録されていません。
   画面下部の「データ管理」セクションから
   customers.json と tanks.json を取り込んでください。
   ```

3. **データ管理セクションへ移動**
   - 画面最下部の「📚 データ管理」セクションまでスクロール

4. **マスタデータ取り込みボタンをクリック**
   - 「📁 マスタデータ取り込み」ボタンをタップ

5. **JSONファイルを選択**
   - `output/customers.json` を選択
   - `output/tanks.json` を選択
   - **2つ同時に選択できます**（複数選択）

6. **成功メッセージ確認**
   ```
   ✅ 取り込み完了！
   
   顧客マスタ: 4件
   タンクマスタ: 11件
   ```

7. **最終取り込み日の表示確認**
   データ管理セクションに以下が表示されます：
   ```
   💡 マスタ更新時：顧客・タンク情報が変更された場合はJSON取り込みで更新してください
   📅 最終取り込み：2025/12/7 14:30:00
   ```

8. **顧客選択ドロップダウンを確認**
   - 画面上部の「顧客を選択」に登録した顧客が表示される

---

## 5. トラブルシューティング

### ❌ エラー: CSVファイルが見つかりません

**原因**: `input/`フォルダにCSVファイルが配置されていない

**解決策**:
```bash
# ディレクトリ確認
ls input/

# 出力例（正常）:
# customers.csv  tanks.csv
```

---

### ❌ エラー: 文字化けが発生

**原因**: CSVファイルのエンコーディングがShift-JISではない

**解決策**:
1. CSVファイルをテキストエディタで開く
2. 「名前を付けて保存」→「エンコーディング: 日本語(Shift JIS)」で保存
3. 再度変換スクリプトを実行

---

### ❌ エラー: JSONファイルの取り込みエラー

**原因**: 不正なJSON形式または必須フィールドの欠落

**解決策**:
1. `output/customers.json` をテキストエディタで開く
2. 以下の形式になっているか確認：
   ```json
   [
     {
       "customerCode": "1001",
       "officialName": "田中農場",
       "officialKana": "タナカノウジョウ",
       "unitPrice": 105
     }
   ]
   ```

---

### ❌ 取り込み成功メッセージが表示されない

**原因**: 古いデータベースが残っている

**解決策**:
1. ブラウザの開発者ツールを開く（F12キー）
2. 「Application」タブ → 「IndexedDB」 → 「oilDB」を右クリック
3. 「Delete database」を選択
4. ページを再読み込み
5. 再度JSON取り込みを実行

---

### 💡 データ更新時の手順

顧客やタンク情報を変更する場合：

1. **CSVファイルを編集**
   - `input/customers.csv` または `input/tanks.csv` を編集

2. **再変換**
   ```bash
   python3 convert_customers_v2.py
   ```

3. **アプリで再取り込み**
   - データ管理セクション → 「📁 マスタデータ取り込み」
   - 新しいJSONファイルを選択
   - **既存データは上書きされます**

---

## 📞 サポート

問題が解決しない場合は、以下の情報を添えてお問い合わせください：

1. エラーメッセージの内容
2. ブラウザの開発者ツールのコンソールログ
3. CSVファイルの先頭5行
4. 使用環境（Mac/iPad/iPhone、ブラウザの種類）

---

## ✅ 本番運用チェックリスト

- [ ] CSVファイルを本番データで作成
- [ ] Shift-JISエンコーディングで保存
- [ ] 変換スクリプト実行（エラーなし）
- [ ] JSONファイルの内容確認
- [ ] アプリでJSON取り込み（成功メッセージ確認）
- [ ] 顧客ドロップダウンに全顧客が表示される
- [ ] 各顧客のタンク情報が正しく表示される
- [ ] テスト給油データ登録
- [ ] CSV出力テスト
- [ ] 過去データ閲覧テスト
- [ ] iPadでの動作確認
- [ ] オフライン時の挙動確認

---

## 🎉 これで本番運用開始です！

何か不明点があればお気軽にお尋ねください。
