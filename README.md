# 灯油配送管理システム v3.1

## 📋 改善履歴

### ✅ フェーズ1: UI改善
- タッチ操作最適化（ボタン・入力欄を大きく）
- カード型UIで情報整理
- ダークモード対応
- レスポンシブデザイン（iPad最適化）
- アイコンで視覚的にわかりやすく

### ✅ フェーズ2: 操作性改善
- **リアルタイム計算表示** - 入力中に自動で金額計算
- **詳細な確認ダイアログ** - 保存前・CSV出力前に内容確認
- **自動入力欄クリア** - 保存後に自動でクリア
- **バリデーション強化** - 容量超過チェック

### ✅ フェーズ3: データ管理改善
- **マスタデータもDBに保存** - 一度取り込めば永続的に使える
- **データ保持期間の最適化** - 1ヶ月間データ保持
- **出力済みフラグ管理** - CSV出力後もデータを保持
- **過去データ閲覧機能** - 出力状態を可視化
- **データバックアップ** - JSON形式でエクスポート
- **データ復元機能** - バックアップから復元
- **自動クリーンアップ** - 1ヶ月以上前の出力済みデータを自動削除

### 🆕 v3.1の改善点
- ✅ 本日の合計サマリー削除（画面スッキリ）
- ✅ CSV出力時にデータを削除しない仕様に変更
- ✅ 出力済みフラグ管理（exported / exportedDate）
- ✅ 1ヶ月間データ保持（トラブル対応・後確認可能）
- ✅ 過去データ閲覧で出力状態を表示（⚠️未出力 / ✅出力済）
- ✅ 自動クリーンアップ機能（起動時に古いデータ削除）

---

## 🚀 使い方

### 初回セットアップ
1. ブラウザでindex.htmlを開く
2. 画面下部「データ管理」セクションへスクロール
3. 「📁 マスタデータ取り込み」をクリック
4. customers.json と tanks.json を選択
5. マスタデータがIndexedDBに保存されます
6. **次回起動時から自動で読み込まれます**

### 日常業務
1. ブラウザでindex.htmlを開く（マスタ自動読み込み）
2. 顧客を選択
3. 各タンクの給油量を入力
4. リアルタイムで計算結果を確認
5. 「給油データ保存」をクリック
6. 業務終了後「CSV出力」

### CSV出力の仕様（重要）
- **未出力データのみ**をCSV出力
- 出力後、データに「出力済みフラグ」が立つ
- **データは削除されず、1ヶ月間保持**
- 1ヶ月以上前の出力済みデータは自動削除
- 過去データ閲覧で出力状態を確認可能

### マスタ更新時
1. CSVファイルを編集（Excel等）
2. Pythonスクリプトで変換
   ```bash
   python convert_customers_v2.py
   ```
3. output フォルダの JSON を確認
4. ブラウザで「📁 マスタデータ取り込み」
5. 新しい JSON を選択
6. マスタが更新されます

---

## 📁 ファイル構成

### Webアプリ
- `index.html` - メインHTMLファイル（UI）
- `app.js` - メインJavaScript（給油管理・マスタ管理）v3.1
- `data-manager.js` - データ管理機能

### マスタデータ（サンプル）
- `customers.json` - 顧客マスタ
- `tanks.json` - タンクマスタ

### データ作成ツール
- `convert_customers_v2.py` - CSV→JSON変換スクリプト（改善版）
- `input/customers.csv` - 顧客マスタCSV
- `input/tanks.csv` - タンクマスタCSV

---

## 💡 主な機能

### 1. データ保持期間管理
- CSV出力後もデータを削除しない
- **1ヶ月間データ保持**で後確認可能
- トラブル時の対応が容易
- CSV紛失時のバックアップとして機能

### 2. 出力済みフラグ管理
各レコードに以下のフラグを保持：
```javascript
{
  exported: false,        // CSV出力済みか
  exportedDate: null      // 出力日時
}
```

### 3. CSV出力フロー
```
未出力データを検索
  ↓
確認ダイアログ表示
  ├─ 期間: 2025/12/1 〜 2025/12/7
  ├─ 件数: 25件
  └─ 合計: 1,150L / ¥127,500
  ↓
CSV出力
  ↓
出力済みフラグを立てる
  ├─ exported: true
  └─ exportedDate: "2025-12-07T14:30:00.000Z"
  ↓
データは削除しない
```

### 4. 自動クリーンアップ
起動時に以下の条件でデータを自動削除：
- ✅ 出力済み（exported: true）
- ✅ 1ヶ月以上前（date < 1ヶ月前）

### 5. 過去データ閲覧（改善版）
- 日付ごとにグループ化
- 各日の出力状態を表示
  - ⚠️ 未出力 X件（赤）
  - ✅ 出力済 X件（緑）
- 各レコードに状態アイコン表示
  - ⚠️ = 未出力
  - ✅ = 出力済

### 6. リアルタイム計算
給油量を入力すると即座に表示：
- 数量（L）
- 単価（円/L）
- 小計
- 消費税（10%）
- 合計金額

---

## 🗄️ データベース構造

### IndexedDB: oilDB (version 3)

#### 1. customers（顧客マスタ）
```javascript
{
  customerCode: "1234",      // 主キー
  officialName: "かっとびファーム",
  officialKana: "かっとびふぁーむ",
  unitPrice: 100
}
```

#### 2. tanks（タンクマスタ）
```javascript
{
  tankId: "1",              // 主キー
  customerCode: "1234",     // インデックス
  tankName: "牛舎１",
  tankCapacity: "480"
}
```

#### 3. records（給油記録）※v3.1で拡張
```javascript
{
  id: 1,                    // 自動採番
  custCode: "1234",
  custName: "かっとびファーム",
  date: "2025/12/7",        // インデックス
  time: "14:30:00",
  tankId: "1",
  tankName: "牛舎１",
  qty: 100,
  unitPrice: 100,
  amount: 10000,
  tax: 1000,
  total: 11000,
  exported: false,          // 🆕 CSV出力済みか
  exportedDate: null        // 🆕 出力日時
}
```

---

## 📊 運用フロー

### 日常業務（1日の流れ）
```
08:00 アプリ起動
       ↓
08:30 顧客A - タンク1,2に給油
       → データ保存（exported: false）
       ↓
10:00 顧客B - タンク1に給油
       → データ保存（exported: false）
       ↓
15:00 顧客C - タンク1,2,3に給油
       → データ保存（exported: false）
       ↓
17:00 業務終了
       → CSV出力
       → データに出力済みフラグ（exported: true）
       → データは削除されない
```

### 後から確認が必要な場合
```
翌日 「昨日の顧客Aの給油量は？」
      ↓
     過去データ閲覧
      ↓
     前日のデータを確認（✅出力済）
```

### 1ヶ月後
```
起動時に自動クリーンアップ
  ↓
1ヶ月以上前の出力済みデータを削除
  ↓
未出力データは保持（警告表示）
```

---

## 🆘 トラブルシューティング

### Q1: CSV出力したのにまだデータが残っている
A: **正常動作です。** v3.1からデータは1ヶ月間保持される仕様になりました。過去データ閲覧で「✅出力済」と表示されていれば問題ありません。

### Q2: 未出力データとは？
A: CSV出力していないデータです。過去データ閲覧で「⚠️未出力」と表示されます。業務終了時にCSV出力を忘れている可能性があります。

### Q3: 古いデータはいつ削除される？
A: 以下の条件を満たすデータが起動時に自動削除されます：
- ✅ CSV出力済み（exported: true）
- ✅ 1ヶ月以上前のデータ

### Q4: 未出力データが溜まっている
A: 「CSV出力」ボタンを押すと、未出力データが全て出力されます。日付範囲が表示されるので確認してください。

### Q5: データを手動で削除したい
A: データ管理セクション → 「過去データ閲覧」から確認後、必要に応じて「全データ削除」を使用してください（要注意）。

---

## 🎯 今後の拡張案

- 未出力データの警告通知
- 日付範囲指定でのCSV出力
- 週次・月次レポート機能
- 顧客別の統計表示
- グラフ・チャート表示

---

## 📝 変更履歴

### v3.1（2025/12/07）
- 本日の合計サマリー削除
- CSV出力時にデータを削除しない仕様に変更
- 出力済みフラグ管理（exported / exportedDate）
- 1ヶ月間データ保持
- 過去データ閲覧で出力状態を表示
- 自動クリーンアップ機能

### v3.0（2025/12/07）
- マスタデータもIndexedDBに保存
- JSON取り込みボタンを最下部に移動
- 初回セットアップガイド追加
- データ構造の統一

### v2.0（2025/12/07）
- リアルタイム計算表示
- 詳細な確認ダイアログ

### v1.0（2025/12/07）
- UI大幅改善
- ダークモード対応
- タッチ操作最適化

---

## 📄 ライセンス

このシステムは個人利用・商用利用ともに自由にご利用いただけます。

---

**Version:** 3.1  
**Last Updated:** 2025/12/07  
**Author:** kattobi5  
**Repository:** https://github.com/kattobi5/kerosene-delivery
