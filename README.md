# 灯油配送管理システム v3.4.0

## 📋 改善履歴

### ✅ フェーズ1-3: 完了
- UI改善、操作性改善、データ管理改善

### ✅ フェーズ4: バグ修正とコード整理（完了）
- **エラーハンドリング強化**
  - JSON取り込み時の詳細エラー表示
  - ファイルサイズチェック（10MB制限）
  - データベース操作失敗時のエラー表示
  - マスタ取り込み日時の表示
  
- **ユーザビリティ改善**
  - 1つ目のタンクに自動フォーカス
  - Enterキーで次の入力欄へ移動
  - バリデーションメッセージ改善（容量超過時に自動調整）
  
- **コード整理**
  - 定数を外出し（DATA_RETENTION_DAYS = 30日）
  - 関数の整理・統合
  - エラー表示の統一化
  - コメント充実
  
- **過去データ閲覧機能強化**
  - 出力状態でフィルター（全て/未出力のみ/出力済のみ）
  - 顧客名で検索
  - リアルタイムフィルタリング
  
- **オフライン対応**
  - オフライン時はCSV出力を無効化
  - ボタン表示を変更（🚫 CSV出力（オフライン））
  - オンライン復帰時に自動で有効化
  - データは引き続き保存可能

### 🆕 v3.4.0の改善点（重要！メーター累積入力対応）
- 🎉 **ローリーメーターの累積値入力に対応**（本番運用最適化）
  - メーターをリセットせずに連続使用可能
  - タンク1: 100L 入力 → 給油量 100L
  - タンク2: 250L 入力 → 給油量 150L（自動計算）
  - タンク3: 450L 入力 → 給油量 200L（自動計算）
- ✅ 入力フィールド名を「メーター値」に変更
- ✅ 実際の給油量をハイライト表示
- ✅ 前のタンクより小さい値のエラーチェック
- ✅ 次のタンクの自動再計算

### 🆕 v3.3.2の改善点
- ✅ **タンク表示順序の修正**: tankIdを数値として正しくソート
  - 修正前: 10, 11, 16, 8, 9（辞書順）
  - 修正後: 8, 9, 10, 11, 16（数値順）
- ✅ 給油データ保存時も同じ順序で処理
- ✅ **バージョン表示追加**: ヘッダーに「v3.3.2」バッジを表示
  - ダークモード対応
  - レスポンシブデザイン（iPad/iPhoneでも見やすい）

### 🆕 v3.3.1の改善点（バグ修正）
- 🐛 **データベースエラー修正**: `metadata`オブジェクトストアが存在しないエラーを修正
- ✅ DBバージョンを4にアップグレード（既存DBを自動アップグレード）
- ✅ エラーハンドリング強化（オブジェクトストアの存在確認）
- ✅ デバッグ用コンソールログ追加

### 🆕 v3.3の改善点
- ✅ **JSON取り込み成功メッセージの改善**: シンプルで分かりやすいメッセージに変更
  - 「✅ 取り込み完了！」
  - 顧客マスタ・タンクマスタの件数を表示
- ✅ **最終取り込み日の表示**: データ管理セクションに最終取り込み日時を表示
  - 例: 「📅 最終取り込み：2025/12/7 14:30:00」

---

## 🚀 使い方

### 初回セットアップ
1. ブラウザでindex.htmlを開く
2. 画面下部「データ管理」セクションへスクロール
3. 「📁 マスタデータ取り込み」をクリック
4. **customers.json と tanks.json を同時選択可能** ✨
5. マスタデータがIndexedDBに保存されます
6. 取り込み日時が表示されます

### 日常業務
1. ブラウザでindex.htmlを開く（マスタ自動読み込み）
2. 顧客を選択
3. **1つ目のタンクに自動フォーカス** ✨
4. 給油量を入力（**Enterキーで次へ移動**） ✨
5. リアルタイムで計算結果を確認
6. 「給油データ保存」をクリック
7. **オンライン時のみ**「CSV出力」可能 ✨

### オフライン作業
- 給油データの入力・保存は**オフラインでも可能**
- CSV出力は**オンライン時のみ**可能
- オフライン時はボタンが自動で無効化
- データは保持されるので、後でオンライン時に出力

### 過去データ閲覧
1. データ管理セクション → 「📅 過去データ閲覧」
2. **フィルター機能**：
   - 出力状態：全て / ⚠️未出力のみ / ✅出力済のみ
   - 顧客名検索：リアルタイムフィルタリング
3. 該当データのみ表示

---

## 💡 主な機能

### 1. エラーハンドリング強化
- JSON取り込み時のエラー詳細表示
- ファイル形式の自動判定と検証
- データベース操作失敗時の適切なエラーメッセージ
- ストレージ容量不足の警告

### 2. マスタ取り込み日時の表示
```
💡 マスタ更新時：顧客・タンク情報が変更された場合は...
📅 最終取り込み：2025/12/7 14:30:00
```

### 3. 操作性の向上
- **自動フォーカス**：顧客選択後、1つ目のタンクに自動フォーカス
- **Enterキー移動**：入力後Enterで次のタンクへ
- **容量超過時の自動調整**：タンク容量を超えた場合、自動で容量まで調整

### 4. バリデーションメッセージ
```
⚠️ タンク容量（480L）を超えています

容量まで自動調整しました
```

### 5. 過去データ閲覧のフィルター機能
- **出力状態フィルター**：
  - 全て
  - ⚠️ 未出力のみ
  - ✅ 出力済のみ
- **顧客名検索**：リアルタイムで絞り込み
- **フィルター結果表示**：「25件のデータ（5日分）を表示中」

### 6. オフライン対応
- **オンライン時**：
  - CSV出力ボタン有効
  - 表示：「📊 CSV出力」
  
- **オフライン時**：
  - CSV出力ボタン無効（グレーアウト）
  - 表示：「🚫 CSV出力（オフライン）」
  - データ入力・保存は引き続き可能

### 7. データ保持期間管理
- 出力済みデータを30日間保持
- 自動クリーンアップ
- トラブル対応・後確認が容易

---

## 🗄️ データベース構造

### IndexedDB: oilDB (version 3)

#### 1. customers（顧客マスタ）
```javascript
{
  customerCode: "1234",
  officialName: "かっとびファーム",
  officialKana: "かっとびふぁーむ",
  unitPrice: 100
}
```

#### 2. tanks（タンクマスタ）
```javascript
{
  tankId: "1",
  customerCode: "1234",
  tankName: "牛舎１",
  tankCapacity: "480"
}
```

#### 3. records（給油記録）
```javascript
{
  id: 1,
  custCode: "1234",
  custName: "かっとびファーム",
  date: "2025/12/7",
  time: "14:30:00",
  tankId: "1",
  tankName: "牛舎１",
  qty: 100,
  unitPrice: 100,
  amount: 10000,
  tax: 1000,
  total: 11000,
  exported: false,
  exportedDate: null
}
```

#### 4. metadata（メタデータ）🆕
```javascript
{
  key: "masterImportDate",
  value: "2025-12-07T14:30:00.000Z"
}
```

---

## 🆘 トラブルシューティング

### Q1: オフラインでCSV出力できない
A: **仕様です。** オンラインになってから出力してください。データは保存されているので安心してください。

### Q2: JSON取り込みでエラーが出る
A: エラーメッセージを確認してください：
- ファイルサイズ：10MB以下にしてください
- JSON形式：配列形式で、必須フィールドを含む必要があります
- customers.json：customerCode, officialName が必須
- tanks.json：tankId, customerCode が必須

### Q3: マスタを取り込んだのに表示されない
A: 以下を確認してください：
- 正しいJSONファイルを選択しましたか？
- エラーメッセージが表示されていませんか？
- 取り込み日時が更新されていますか？（データ管理セクション）

### Q4: データベース操作に失敗する
A: 以下の可能性があります：
- ストレージ容量不足：ブラウザの設定で容量を確認
- プライベートモード：通常モードで使用してください
- 複数タブで同時操作：1つのタブで使用してください

---

## 🎯 将来の拡張案

### GPS機能（設計メモ）

#### 概要
GPS位置情報を使用して、顧客を自動選択する機能

#### 実装案
```javascript
// 1. 顧客マスタに緯度経度を追加
{
  customerCode: "1234",
  officialName: "かっとびファーム",
  location: {
    lat: 43.064171,
    lng: 141.346939
  }
}

// 2. 現在地取得
navigator.geolocation.getCurrentPosition((position) => {
  const currentLat = position.coords.latitude;
  const currentLng = position.coords.longitude;
  
  // 3. 最も近い顧客を検索
  const nearest = findNearestCustomer(currentLat, currentLng);
  
  // 4. 自動選択
  selectCustomer(nearest.customerCode);
});

// 5. 距離計算（ヒュベニの簡易式）
function calculateDistance(lat1, lng1, lat2, lng2) {
  // 実装...
}
```

#### 必要な追加機能
- 顧客マスタにGPS座標追加
- GPS許可のリクエスト
- 位置情報の精度チェック
- 手動選択との切り替え
- 到着判定（半径50m以内など）

#### 利点
- 到着時に自動で顧客選択
- 入力ミス防止
- 作業効率向上

---

## 📝 変更履歴

### v3.2（2025/12/07）
- エラーハンドリング強化
- マスタ取り込み日時の表示
- 自動フォーカス＆Enterキー移動
- バリデーション改善
- 過去データ閲覧にフィルター・検索機能
- オフライン時のCSV出力制御

### v3.1（2025/12/07）
- 本日の合計サマリー削除
- データ保持期間の最適化（30日）
- 出力済みフラグ管理

### v3.0（2025/12/07）
- マスタデータもIndexedDBに保存
- データ構造の統一

### v2.0（2025/12/07）
- リアルタイム計算表示
- 詳細な確認ダイアログ

### v1.0（2025/12/07）
- UI大幅改善
- ダークモード対応

---

## 📄 ライセンス

このシステムは個人利用・商用利用ともに自由にご利用いただけます。

---

**Version:** 3.2  
**Last Updated:** 2025/12/07  
**Author:** kattobi5  
**Repository:** https://github.com/kattobi5/kerosene-delivery
