<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>灯油配送管理デモ（修正版）</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    label { display: block; margin-top: 12px; }
    select, input { padding: 4px; }
    .tank-box { padding: 10px; border: 1px solid #ccc; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>顧客選択</h2>
  <button onclick="importJSON()">JSON取り込み</button>
  <label>
    顧客：
    <select id="customerSelect" onchange="onCustomerChange()"></select>
  </label>

  <h2>タンク情報</h2>
  <div id="tankContainer"></div>

  <!-- 給油データ保存 & CSV出力 ボタン追加 -->
  <div style="margin-top:20px;">
    <button onclick="saveRecord()">給油データ保存</button>
    <button onclick="exportTodayCSV()">CSV出力</button>
  </div>

<script>
//------------------------------------------------------------
// 顧客・タンクデータ
//------------------------------------------------------------
let customers = [];
let tanks = [];

//------------------------------------------------------------
// 初期読み込み
//------------------------------------------------------------
async function loadCustomers() {
  try {
    const res = await fetch("customers.json");
    customers = await res.json();
    populateCustomerSelect();
  } catch (e) { console.error(e); }
}

async function loadTanks() {
  try {
    const res = await fetch("tanks.json");
    tanks = await res.json();
  } catch (e) { console.error(e); }
}

//------------------------------------------------------------
// 顧客ドロップダウン更新
//------------------------------------------------------------
function populateCustomerSelect() {
  const select = document.getElementById("customerSelect");
  select.innerHTML = "";
  customers.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.customerCode;
    opt.textContent = `${c.customerCode} : ${c.officialName}`;
    select.appendChild(opt);
  });
}

//------------------------------------------------------------
// 顧客選択 → タンク一覧更新
//------------------------------------------------------------
function onCustomerChange() {
  const code = document.getElementById("customerSelect").value;
  const cust = customers.find(c => c.customerCode === code);

  const container = document.getElementById("tankContainer");
  container.innerHTML = "";
  if (!cust) return;

  const custTanks = tanks.filter(t => t.customerCode === code);

  custTanks.forEach((t, idx) => {
    const div = document.createElement("div");
    div.className = "tank-box";
    div.innerHTML = `
      <div><b>タンク ${idx + 1}</b></div>
      <div>名称：${t.tankName}</div>
      <div>容量：${t.tankCapacity}</div>
      <div>ID：${t.tankId}</div>
      <label>給油量(L)：<input type="number" id="tankQty_${idx}" min="0"></label>
    `;
    container.appendChild(div);
  });
}

//------------------------------------------------------------
// JSON取り込み（customers.json / tanks.json 自動判定）
//------------------------------------------------------------
function importJSON() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json,.json';

  input.onchange = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      if (Array.isArray(data) && data[0]?.customerCode) {
        customers = data;
        populateCustomerSelect();
        alert('customers.json を取り込みました');
        if (tanks.length > 0) alert('取り込み完了！（customers + tanks）');
      }
      else if (Array.isArray(data) && data[0]?.tankId) {
        tanks = data;
        alert('tanks.json を取り込みました');
        if (customers.length > 0) alert('取り込み完了！（customers + tanks）');
      }
      else {
        alert('JSON形式が不正です');
      }
    } catch (err) {
      console.error(err);
      alert('JSON解析に失敗しました');
    }
  };

  document.body.appendChild(input);
  input.click();
  setTimeout(() => document.body.removeChild(input), 500);
}

//------------------------------------------------------------
// IndexedDB
//------------------------------------------------------------
let db;
const req = indexedDB.open("oilDB", 1);

req.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains("records")) {
    db.createObjectStore("records", { keyPath: "id", autoIncrement: true });
  }
};
req.onsuccess = e => { db = e.target.result; };

//------------------------------------------------------------
// 給油データ保存
//------------------------------------------------------------
function saveRecord() {
  const code = document.getElementById("customerSelect").value;
  const cust = customers.find(c => c.customerCode === code);
  if (!cust) return alert("顧客が選択されていません");

  const custTanks = tanks.filter(t => t.customerCode === code);

  const tx = db.transaction(["records"], "readwrite");
  const store = tx.objectStore("records");
  const now = new Date();

  custTanks.forEach((t, idx) => {
    const qty = Number(document.getElementById(`tankQty_${idx}`).value);
    if (!qty) return;

    const unit = cust.unitPrice || 0;
    const amount = qty * unit;
    const tax = Math.round(amount * 0.1);
    const total = amount + tax;

    store.put({
      custCode: cust.customerCode,
      custName: cust.officialName,
      date: now.toLocaleDateString(),
      time: now.toLocaleTimeString(),
      tankId: t.tankId,
      tankName: t.tankName,
      qty, unitPrice: unit, amount, tax, total
    });
  });

  alert("保存しました");
}

//------------------------------------------------------------
// CSV出力（iCloud Drive 保存対応）
//------------------------------------------------------------
function exportTodayCSV() {
  const today = new Date().toLocaleDateString();
  const tx = db.transaction(["records"], "readonly");
  const store = tx.objectStore("records");
  const rows = [];

  store.openCursor().onsuccess = e => {
    const cur = e.target.result;
    if (cur) {
      if (cur.value.date === today) rows.push(cur.value);
      cur.continue();
    } else {
      makeCSV(rows);
      clearTodayData();
    }
  };
}

async function makeCSV(rows) {
  let csv = "得意先cd,得意先名,売上日,給油時刻,売上区分,数量,単価,金額,消費税,合計額,入金額,タンクID\n";

  rows.forEach(r => {
    csv += `${r.custCode},${r.custName},${r.date},${r.time},売掛,${r.qty},${r.unitPrice},${r.amount},${r.tax},${r.total},0,${r.tankId}
`;
  });

  try {
    // Safari は showSaveFilePicker が実装されていても挙動が不安定なので強制的に除外
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    if (window.showSaveFilePicker && !isSafari) {
      const handle = await window.showSaveFilePicker({
        suggestedName: `today_delivery_${getTimestamp()}.csv`,
        types: [{ description: "CSV File", accept: { "text/csv": [".csv"] } }],
        excludeAcceptAllOption: false,
        startIn: "documents"
      });

      const writable = await handle.createWritable();
      await writable.write(new Blob([csv], { type: "text/csv" }));
      await writable.close();
      alert("ファイルを保存しました（iCloud Drive OK）");
    } else {
      function getTimestamp() {
  const d = new Date();
  const yy = String(d.getFullYear()).slice(-2);
  const MM = String(d.getMonth() + 1).padStart(2, '0');
  const DD = String(d.getDate()).padStart(2, '0');
  const hh = String(d.getHours()).padStart(2, '0');
  const mm = String(d.getMinutes()).padStart(2, '0');
  const ss = String(d.getSeconds()).padStart(2, '0');
  return `${yy}${MM}${DD}${hh}${mm}${ss}`;
}

// Safari/iPadOS 用：ダウンロード→共有シート→iCloud Drive 保存が可能
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `today_delivery_${getTimestamp()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      alert("CSVをダウンロードしました（共有シートからiCloud保存）");
    }
  } catch (e) {
    console.error(e);
    alert("保存がキャンセルされました");
  }
}
//------------------------------------------------------------
// 今日のデータ削除
//------------------------------------------------------------
function clearTodayData() {
  const today = new Date().toLocaleDateString();
  const tx = db.transaction(["records"], "readwrite");
  const store = tx.objectStore("records");

  store.openCursor().onsuccess = e => {
    const cur = e.target.result;
    if (cur) {
      if (cur.value.date === today) cur.delete();
      cur.continue();
    }
  };
}
// ページロード時に customers.json と tanks.json を読む
window.addEventListener("DOMContentLoaded", () => {
  loadCustomers();
  loadTanks();
});

</script>
</body>
</html>
